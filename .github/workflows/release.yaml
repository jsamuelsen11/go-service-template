name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write
  packages: write
  id-token: write
  attestations: write
  security-events: write

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build-binary:
    name: Build Binary (${{ matrix.goos }}/${{ matrix.goarch }})
    runs-on: ubuntu-latest
    timeout-minutes: 15
    strategy:
      matrix:
        include:
          - goos: linux
            goarch: amd64
          - goos: linux
            goarch: arm64
          - goos: darwin
            goarch: amd64
          - goos: darwin
            goarch: arm64
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version-file: go.mod
          cache: true

      - name: Download dependencies
        run: go mod download

      - name: Get version info
        id: version
        run: |
          VERSION=${GITHUB_REF_NAME#v}
          GIT_COMMIT=$(git rev-parse --short HEAD)
          BUILD_TIME=$(date -u '+%Y-%m-%dT%H:%M:%SZ')
          {
            echo "version=${VERSION}"
            echo "commit=${GIT_COMMIT}"
            echo "build_time=${BUILD_TIME}"
          } >> "$GITHUB_OUTPUT"

      - name: Build binary
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
          CGO_ENABLED: 0
        run: |
          BINARY_NAME="service-${{ matrix.goos }}-${{ matrix.goarch }}"

          go build -ldflags "-s -w \
            -X main.Version=${{ steps.version.outputs.version }} \
            -X main.Commit=${{ steps.version.outputs.commit }} \
            -X main.BuildTime=${{ steps.version.outputs.build_time }}" \
            -o "dist/${BINARY_NAME}" ./cmd/service

      - name: Upload binary artifact
        uses: actions/upload-artifact@v6
        with:
          name: binary-${{ matrix.goos }}-${{ matrix.goarch }}
          path: dist/
          retention-days: 1

  build-docker:
    name: Build Docker Image
    runs-on: ubuntu-latest
    timeout-minutes: 30
    outputs:
      digest: ${{ steps.build.outputs.digest }}
      image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Get version info
        id: version
        run: |
          VERSION=${GITHUB_REF_NAME#v}
          GIT_COMMIT=$(git rev-parse --short HEAD)
          BUILD_TIME=$(date -u '+%Y-%m-%dT%H:%M:%SZ')
          {
            echo "version=${VERSION}"
            echo "commit=${GIT_COMMIT}"
            echo "build_time=${BUILD_TIME}"
          } >> "$GITHUB_OUTPUT"

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            type=sha,prefix=sha-
            type=raw,value=latest

      - name: Build and push Docker image
        id: build
        uses: docker/build-push-action@v6
        with:
          context: .
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: |
            VERSION=${{ steps.version.outputs.version }}
            GIT_COMMIT=${{ steps.version.outputs.commit }}
            BUILD_TIME=${{ steps.version.outputs.build_time }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          provenance: true
          sbom: true

  sbom:
    name: Generate SBOM
    runs-on: ubuntu-latest
    needs: [build-docker]
    timeout-minutes: 15
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version-file: go.mod
          cache: true

      - name: Download dependencies
        run: go mod download

      - name: Install Syft
        uses: anchore/sbom-action/download-syft@v0.17.0

      - name: Generate Go module SBOM (CycloneDX)
        run: syft . -o cyclonedx-json=sbom-go.cdx.json

      - name: Generate Go module SBOM (SPDX)
        run: syft . -o spdx-json=sbom-go.spdx.json

      - name: Generate container SBOM
        run: |
          syft "${{ needs.build-docker.outputs.image }}@${{ needs.build-docker.outputs.digest }}" \
            -o cyclonedx-json=sbom-container.cdx.json

      - name: Upload SBOM artifacts
        uses: actions/upload-artifact@v6
        with:
          name: sbom
          path: |
            sbom-go.cdx.json
            sbom-go.spdx.json
            sbom-container.cdx.json
          retention-days: 90

      - name: Run Trivy vulnerability scan
        uses: aquasecurity/trivy-action@0.33.1
        with:
          image-ref: "${{ needs.build-docker.outputs.image }}@${{ needs.build-docker.outputs.digest }}"
          format: "sarif"
          output: "trivy-results.sarif"
          severity: "CRITICAL,HIGH"

      - name: Upload Trivy scan results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: "trivy-results.sarif"

  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [build-binary, build-docker, sbom]
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Download all binary artifacts
        uses: actions/download-artifact@v7
        with:
          pattern: binary-*
          path: dist/
          merge-multiple: true

      - name: Download SBOM artifacts
        uses: actions/download-artifact@v7
        with:
          name: sbom
          path: dist/

      - name: Generate checksums
        working-directory: dist
        run: |
          sha256sum ./* > checksums.txt
          cat checksums.txt

      - name: Generate release notes
        run: |
          VERSION=${GITHUB_REF_NAME#v}

          cat << 'EOF' > release-notes.md
          ## What's Changed

          EOF

          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          if [ -n "$PREV_TAG" ]; then
            {
              echo "### Commits since ${PREV_TAG}"
              echo ""
              git log --oneline "${PREV_TAG}..HEAD"
              echo ""
            } >> release-notes.md
          fi

          cat << EOF >> release-notes.md

          ## Docker Image

          \`\`\`bash
          docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${VERSION}
          \`\`\`

          ## Verification

          Download \`checksums.txt\` and verify:
          \`\`\`bash
          sha256sum -c checksums.txt
          \`\`\`

          ## SBOM

          Software Bill of Materials is available in CycloneDX and SPDX formats.
          EOF

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          body_path: release-notes.md
          files: |
            dist/*
          fail_on_unmatched_files: true
          generate_release_notes: true
