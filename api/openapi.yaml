openapi: 3.0.3

info:
  title: Go Service Template API
  description: |
    Enterprise-grade Go backend service template implementing Clean/Hexagonal Architecture.

    ## Health Endpoints

    The service exposes health endpoints under the `/-/` prefix:
    - `/-/live` - Liveness probe (always returns 200 if process is running)
    - `/-/ready` - Readiness probe (checks all registered health checkers)
    - `/-/build` - Build information (version, commit, build time)
    - `/-/metrics` - Prometheus metrics

    ## Error Handling

    All errors follow a standard envelope format with error code, message, and optional details.
    Trace IDs are included when available for debugging.
  version: 1.0.0
  contact:
    name: API Support
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT

servers:
  - url: http://localhost:8080
    description: Local development server

tags:
  - name: Health
    description: Health check and operational endpoints
  - name: Quotes
    description: Quote retrieval endpoints demonstrating the full architecture

paths:
  /-/live:
    get:
      operationId: getLiveness
      summary: Liveness probe
      description: |
        Returns 200 OK if the process is running.
        Used by Kubernetes liveness probes to detect if the container needs restart.
        This endpoint does NOT check dependencies - that's what readiness is for.
      tags:
        - Health
      responses:
        "200":
          description: Process is running and accepting requests
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/LivenessResponse"
              example:
                status: ok

  /-/ready:
    get:
      operationId: getReadiness
      summary: Readiness probe
      description: |
        Returns 200 OK if all registered health checks pass.
        Returns 503 Service Unavailable if any check fails.
        Used by Kubernetes readiness probes to determine if the container should receive traffic.
      tags:
        - Health
      responses:
        "200":
          description: All health checks passed, service can receive traffic
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ReadinessResponse"
              example:
                status: healthy
                checks:
                  database:
                    status: healthy
                    duration: 5000000
                  redis:
                    status: healthy
                    duration: 2000000
        "500":
          description: Internal server error occurred during health check
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                error:
                  code: INTERNAL_ERROR
                  message: "Failed to execute health checks"
                traceId: "4bf92f3577b34da6a3ce929d0e0e4736"
        "503":
          description: One or more health checks failed, service should not receive traffic
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ReadinessResponse"
              example:
                status: unhealthy
                checks:
                  database:
                    status: healthy
                    duration: 5000000
                  redis:
                    status: unhealthy
                    message: "connection refused"
                    duration: 30000000000

  /-/build:
    get:
      operationId: getBuildInfo
      summary: Build information
      description: |
        Returns build-time information including version, git commit, and build timestamp.
        Useful for debugging and verifying deployments.
      tags:
        - Health
      responses:
        "200":
          description: Build metadata for the running service instance
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/BuildInfo"
              example:
                version: "1.2.3"
                commit: "abc123def456"
                buildTime: "2025-01-15T10:00:00Z"
                goVersion: "go1.22.0"

  /-/metrics:
    get:
      operationId: getMetrics
      summary: Prometheus metrics
      description: |
        Exposes Prometheus-formatted metrics for monitoring.
        Includes HTTP request metrics, Go runtime metrics, and custom application metrics.
      tags:
        - Health
      responses:
        "200":
          description: Prometheus text-based metrics exposition format
          content:
            text/plain:
              schema:
                type: string
              example: |
                # HELP http_server_request_duration_seconds HTTP request duration
                # TYPE http_server_request_duration_seconds histogram
                http_server_request_duration_seconds_bucket{le="0.005"} 100

  /api/v1/quotes/random:
    get:
      operationId: getRandomQuote
      summary: Get a random quote
      description: |
        Fetches a random quote from the external quote service.
        Demonstrates the full hexagonal architecture:
        - HTTP Handler → Application Service → ACL Client → External API
      tags:
        - Quotes
      responses:
        "200":
          description: A random quote was successfully retrieved
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/QuoteResponse"
              example:
                id: "abc123"
                content: "The only way to do great work is to love what you do."
                author: "Steve Jobs"
                tags:
                  - inspirational
                  - work
        "503":
          description: External quote service is temporarily unavailable
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                error:
                  code: SERVICE_UNAVAILABLE
                  message: "Service temporarily unavailable"
                traceId: "4bf92f3577b34da6a3ce929d0e0e4736"

  /api/v1/quotes/{id}:
    get:
      operationId: getQuoteById
      summary: Get a quote by ID
      description: |
        Fetches a specific quote by its unique identifier.
        Returns 404 if the quote does not exist.
      tags:
        - Quotes
      parameters:
        - name: id
          in: path
          required: true
          description: The unique identifier of the quote
          schema:
            type: string
          example: "abc123"
      responses:
        "200":
          description: The quote was found and returned
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/QuoteResponse"
              example:
                id: "abc123"
                content: "The only way to do great work is to love what you do."
                author: "Steve Jobs"
                tags:
                  - inspirational
                  - work
        "400":
          description: Invalid request (e.g., missing quote ID)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                error:
                  code: BAD_REQUEST
                  message: "quote ID is required"
        "404":
          description: Quote not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                error:
                  code: NOT_FOUND
                  message: "quote abc123: not found"
                traceId: "4bf92f3577b34da6a3ce929d0e0e4736"
        "503":
          description: Unable to reach external quote service
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                error:
                  code: SERVICE_UNAVAILABLE
                  message: "Service temporarily unavailable"
                traceId: "4bf92f3577b34da6a3ce929d0e0e4736"

components:
  schemas:
    LivenessResponse:
      description: Response indicating the service process is alive and running
      type: object
      required:
        - status
      properties:
        status:
          type: string
          description: Always "ok" if the process is running
          example: ok

    ReadinessResponse:
      description: Response indicating service readiness with individual component health checks
      type: object
      required:
        - status
      properties:
        status:
          type: string
          enum: [healthy, unhealthy]
          description: Overall health status
          example: healthy
        checks:
          type: object
          additionalProperties:
            $ref: "#/components/schemas/CheckResult"
          description: Individual health check results keyed by component name
          example:
            database:
              status: healthy
              duration: 5000000

    CheckResult:
      description: Result of an individual health check for a service component
      type: object
      required:
        - status
        - duration
      properties:
        status:
          type: string
          enum: [healthy, unhealthy]
          description: Health status of this component
          example: healthy
        message:
          type: string
          description: Error message if unhealthy
          example: "connection refused"
        duration:
          type: integer
          format: int64
          description: Duration of the health check in nanoseconds
          example: 5000000

    BuildInfo:
      description: Build-time metadata injected during compilation via ldflags
      type: object
      required:
        - version
        - commit
        - buildTime
        - goVersion
      properties:
        version:
          type: string
          description: Semantic version of the service
          example: "1.2.3"
        commit:
          type: string
          description: Git commit SHA
          example: "abc123def456"
        buildTime:
          type: string
          description: Build timestamp in RFC3339 format
          example: "2025-01-15T10:00:00Z"
        goVersion:
          type: string
          description: Go version used to build
          example: "go1.22.0"

    ErrorResponse:
      description: Standard error envelope returned for all API errors
      type: object
      required:
        - error
      properties:
        error:
          allOf:
            - $ref: "#/components/schemas/ErrorDetail"
          example:
            code: NOT_FOUND
            message: "The requested resource was not found"
        traceId:
          type: string
          description: OpenTelemetry trace ID for debugging
          example: "4bf92f3577b34da6a3ce929d0e0e4736"

    ErrorDetail:
      description: Detailed error information with machine-readable code and human-readable message
      type: object
      required:
        - code
        - message
      properties:
        code:
          type: string
          description: Machine-readable error code
          enum:
            - NOT_FOUND
            - CONFLICT
            - VALIDATION_ERROR
            - FORBIDDEN
            - UNAUTHORIZED
            - SERVICE_UNAVAILABLE
            - INTERNAL_ERROR
            - TIMEOUT
            - BAD_REQUEST
          example: NOT_FOUND
        message:
          type: string
          description: Human-readable error message
          example: "The requested resource was not found"
        details:
          type: object
          additionalProperties:
            type: string
          description: Additional error details (e.g., field-level validation errors)
          example:
            field: "email"
            reason: "invalid format"

    QuoteResponse:
      description: A quote with its author and metadata
      type: object
      required:
        - id
        - content
        - author
      properties:
        id:
          type: string
          description: Unique identifier for the quote
          example: "abc123"
        content:
          type: string
          description: The text of the quote
          example: "The only way to do great work is to love what you do."
        author:
          type: string
          description: The person who said or wrote the quote
          example: "Steve Jobs"
        tags:
          type: array
          items:
            type: string
          description: Categories or themes associated with the quote
          example:
            - inspirational
            - work
